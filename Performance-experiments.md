This page is more for failed experiments, as successful ones can get merged (but feel free to add them here too ^^).

# Skipping conversion of parameters of constructors and of the domain of lambdas (failed)

When converting `fun x : A => e` and `fun x : A' => e'` if I know they
have the same type `forall x : A, B` I know that `A == A'` (Pi-injectivity).

Analogously when converting constructors we can skip parameters without breaking soundness.

The experiment fails because the kernel converts application arguments right to left, so if we have `P : forall T, T -> ...` and convert `P (forall A0, ...) (fun x : A0' => ...)` and `P (forall A1, ...) (fun x : A1' => ...)` we look at the lambdas before testing `A0 == A1` (which by typing would imply `A0' == A1'`). This means skipping the lambda annotations skips a chance at early failure. Of course the same is true of skipping constructor parameters. Here's a partial bench: https://ci.inria.fr/coq/view/benchmarking/job/benchmark-part-of-the-branch/391/console
```
┌──────────────────────────┬───────────────────────────┬───────────────────────────────────────┬───────────────────────────────────────┬─────────────────────────┬─────────────────┐
│                          │       user time [s]       │              CPU cycles               │           CPU instructions            │  max resident mem [KB]  │   mem faults    │
│                          │                           │                                       │                                       │                         │                 │
│             package_name │     NEW     OLD   PDIFF   │           NEW           OLD   PDIFF   │            NEW           OLD  PDIFF   │     NEW     OLD PDIFF   │ NEW OLD PDIFF   │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│       coq-mathcomp-field │  205.60  461.51  -55.45 % │  568829876254 1281746757731  -55.62 % │   819365613062 2059996916568 -60.22 % │  745460  814356 -8.46 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│ coq-mathcomp-real_closed │  117.40  172.82  -32.07 % │  324619461164  478365156189  -32.14 % │   436543675931  699685289928 -37.61 % │  811412  844848 -3.96 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│     coq-mathcomp-algebra │  157.57  185.61  -15.11 % │  435515533971  512539927127  -15.03 % │   559400684428  690239426679 -18.96 % │  643312  652328 -1.38 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-character │  255.34  275.70   -7.38 % │  707539906521  764571391145   -7.46 % │   986603630955 1085745868624  -9.13 % │ 1099132 1127652 -2.53 % │   0   5 -100.00 % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│    coq-mathcomp-fingroup │   60.84   64.40   -5.53 % │  167026713738  177626419100   -5.97 % │   218191435415  236222596014  -7.63 % │  588172  593152 -0.84 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│              coq-bignums │   79.67   80.06   -0.49 % │  219377009283  220962251825   -0.72 % │   283573204732  286100393647  -0.88 % │  529324  527276 +0.39 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-ssreflect │   44.67   44.67   +0.00 % │  121988881003  122288140972   -0.24 % │   141851033114  142842125752  -0.69 % │  536056  537640 -0.29 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│      coq-formal-topology │   37.55   37.42   +0.35 % │  100801859530  100686387892   +0.11 % │   125318244163  125809356994  -0.39 % │  483236  483448 -0.04 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│    coq-mathcomp-solvable │  230.96  201.62  +14.55 % │  639721848901  558026456354  +14.64 % │   889219447748  767706053248 +15.83 % │  840240  841228 -0.12 % │   0   0  +nan % │
├──────────────────────────┼───────────────────────────┼───────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-odd_order │ 2878.81 1427.47 +101.67 % │ 8004985597716 3963150813359 +101.99 % │ 12823742839111 6663549213977 +92.45 % │ 1406176 1391924 +1.02 % │   0   0  +nan % │
└──────────────────────────┴───────────────────────────┴───────────────────────────────────────┴───────────────────────────────────────┴─────────────────────────┴─────────────────┘
```

If we change the comparison order to left to right (as in #396) the above is alleviated but other places slow down to death: https://ci.inria.fr/coq/view/benchmarking/job/benchmark-part-of-the-branch/393/console
```
┌──────────────────────────┬──────────────────────────┬──────────────────────────────────────┬──────────────────────────────────────┬─────────────────────────┬─────────────────┐
│                          │      user time [s]       │              CPU cycles              │           CPU instructions           │  max resident mem [KB]  │   mem faults    │
│                          │                          │                                      │                                      │                         │                 │
│             package_name │     NEW     OLD  PDIFF   │           NEW           OLD  PDIFF   │           NEW           OLD  PDIFF   │     NEW     OLD PDIFF   │ NEW OLD PDIFF   │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│       coq-mathcomp-field │  231.34  460.46 -49.76 % │  640657643986 1278240468084 -49.88 % │  938840609184 2059983208186 -54.42 % │  749856  814472 -7.93 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│ coq-mathcomp-real_closed │  128.33  172.62 -25.66 % │  354519892910  477561398004 -25.76 % │  485813524117  699666070629 -30.56 % │  820416  844836 -2.89 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│     coq-mathcomp-algebra │  165.87  184.82 -10.25 % │  457805151555  511415943712 -10.48 % │  596950648013  690197168687 -13.51 % │  647160  652284 -0.79 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│    coq-mathcomp-fingroup │   60.34   64.52  -6.48 % │  165936604399  177375464335  -6.45 % │  217866367230  236360925820  -7.82 % │  586992  593140 -1.04 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-ssreflect │   44.44   45.01  -1.27 % │  121629722412  122142651036  -0.42 % │  141930184433  142889177229  -0.67 % │  538080  537696 +0.07 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│              coq-bignums │   79.58   80.22  -0.80 % │  219446666227  220754218164  -0.59 % │  283500824146  286198520125  -0.94 % │  525864  527396 -0.29 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-odd_order │ 1491.34 1426.42  +4.55 % │ 4143753719381 3962374851065  +4.58 % │ 6959165055834 6663513117214  +4.44 % │ 1366556 1389552 -1.65 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│    coq-mathcomp-solvable │  211.22  201.86  +4.64 % │  584641881650  557846578469  +4.80 % │  822480782071  767855064436  +7.11 % │  878612  866188 +1.43 % │   0   0  +nan % │
├──────────────────────────┼──────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼─────────────────────────┼─────────────────┤
│   coq-mathcomp-character │  293.63  275.63  +6.53 % │  814656149843  764490284216  +6.56 % │ 1167220824117 1085807185628  +7.50 % │ 1121104 1127156 -0.54 % │   0   0  +nan % │
└──────────────────────────┴──────────────────────────┴──────────────────────────────────────┴──────────────────────────────────────┴─────────────────────────┴─────────────────┘
```
after those developments formal topology didn't finish in ~8h (then I killed it). CI results for #396 at the time insinuate this may be in the corn dependency.

See https://github.com/SkySkimmer/coq/commit/1575ec75346a00955fd2f3f95179e958bbdc8b77 for implementation issues related to badly behaving callers.